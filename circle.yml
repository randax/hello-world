machine:
  node:
    version: 4.4
  services:
    - docker
  environment:
    IMAGE_NAME: hello-world

dependencies:
  override:
    - docker info
    - docker build -t $IMAGE_NAME:$(git describe --tags --always) .

  cache_directories:
      - ~/kubernetes

  pre:
    - ./ensure-kubernetes-installed.sh
    - npm install --global mocha
#    - npm install --global istanbul
    - npm install --production
    - docker build -t $EXTERNAL_REGISTRY_ENDPOINT/hello:$CIRCLE_SHA1 .

test:
  override:
    - mocha test/unit
    - docker run -d -p 8000:8000 $IMAGE_NAME:$(git describe --tags --always); sleep 10
    - mocha test/integration
#    - istanbul cover _mocha --dir $CIRCLE_ARTIFACTS/coverage

deployment:
